<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<meta id="_csrf" name="_csrf" th:content="${_csrf.getToken()}"/>
<meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.getHeaderName()}"/>
<head th:replace="layout/header::userHead"></head>
<body>
<div th:replace="layout/top::header"></div>
<div class="container">
    <div class="row align-items-start">
        <nav class="col-md-2 d-none d-md-block bg-light sidebar">
            <div class="sidebar-sticky">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <div style="padding-top:10px;" class="nav flex-column nav-pills" aria-orientation="vertical">
                            <a th:href="@{/}" style="margin:5px;" class="nav-link active">대시보드</a>
                            <a th:href="@{/mypage}" style="margin:5px;" class="nav-link text-primary">마이페이지</a>
                            <a th:href="@{/messages}" style="margin:5px;" class="nav-link text-primary">메시지</a>
                            <a th:href="@{/config}" style="margin:5px;" class="nav-link text-primary">환경설정</a>
                            <a href="#" onclick="message()" style="margin: 5px" class="nav-link text-primary">Test</a>
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
        <div style="padding-top:50px;"  class="col">
            <div class="container text-center">
                <h1 class="text-primary">DASHBOARD</h1>
                <div class="security"></div>
                <h1>Core Spring Security 에 오신 것을 환영합니다.</h1>
            </div>
        </div>
    </div>
</div>
<div th:replace="layout/footer::footer"></div>
<script>
    const message = (e) => {
        const csrf = document.querySelector("meta[name='_csrf']").getAttribute("content")
        const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");
        let url = "/messages";
        fetch("/api/messages", {
            method: "POST",
            headers: {
                [csrfHeader]: csrf,
                "X-Requested-With": "XMLHttpRequest",
                "Content-Type": "application/json"
            }
        }).then(res => res.json())
        .then(response => {
            const { status, message }  = response;
            if (status === 401) {
                url = `/api/login?error=true&exception=${message}&errorMessage=Need Authorize`;
            } else if (status === 403) {
                url = `/api/denied?exception=exception=${message}`;
            }

            window.location = url;
        }).catch(error => {
            console.error({error});
        });
    }
</script>
</body>
</html>